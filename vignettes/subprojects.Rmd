---
title: "Subprojects in pepr"
author: "Michal Stolarczyk"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This vignette will show you how and why to use the subbprojects functionality of the `pepr` package. For introductory information about the package visit the [documentation page](http://code.databio.org/pepr/index.html). For the basic information about the PEP concept visit the [project website](https://pepkit.github.io/).

### Problem/Goal

The example below demonstrates how and why to use implied columns functionality to **define numerous similar projects in a single project config file**. This functionality is extremely convenient when one has to define projects with small settings discreptancies, like different attributes in the annotation sheet. For example libraries `ABCD` and `EFGH` instead of the original `RRBS`.

```{r ,echo=FALSE}
library(knitr)
sampleAnnotation = system.file(
"extdata",
"example_peps-master",
"example_subprojects1",
"sample_annotation.csv",
package = "pepr"
)
sampleAnnotationDF = read.table(sampleAnnotation, sep = ",", header = T)
knitr::kable(sampleAnnotationDF, format = "html") 
```

----

### Solution

This can be achieved by using subprojects section of `project_config.yaml` file (presented below). The attributes specified in the lowest levels of this section (here: `sample_annotation`) overwrite the original ones. Consequently, a completely new set of settings is determined with just this value changed. Moreover, multiple subprojects can be defined in a single config file. Based on the file presented below, two subprojects will be defined: `newLib` and `newLib2`.

```{r, echo=FALSE,message=TRUE,collapse=TRUE,comment=" "}
library(pepr)
projectConfig = system.file(
"extdata",
"example_peps-master",
"example_subprojects1",
"project_config.yaml",
package = "pepr"
)
printNestedList(yaml::read_yaml(projectConfig))
```

Obviously, the subprojects functionality can be combined with other `pepr` package options, e.g. implied and derieved columns. The derived columns functionality is used in the example considered here (`derived_columns` and `data_soures` keys in the config file).


Files `sample_annotation_newLib.csv` and `sample_annotation_newLib2.csv` introduce different the `library` attributes. They are used in the subprojects `newLib` and `newLib2`, respectively.

```{r ,echo=FALSE}
library(knitr)
sampleAnnotation = system.file(
  "extdata",
  "example_peps-master",
  "example_subprojects1",
  "sample_annotation_newLib.csv",
  package = "pepr"
  )
  sampleAnnotationDF = read.table(sampleAnnotation, sep = ",", header = T)
  knitr::kable(sampleAnnotationDF, format = "html") 
```

```{r ,echo=FALSE}
library(knitr)
sampleAnnotation = system.file(
"extdata",
"example_peps-master",
"example_subprojects1",
"sample_annotation_newLib2.csv",
package = "pepr"
)
sampleAnnotationDF = read.table(sampleAnnotation, sep = ",", header = T)
knitr::kable(sampleAnnotationDF, format = "html") 
```

----

### Code

Load `pepr` and read in the project metadata by specifying the path to the `project_config.yaml`:

```{r}
library(pepr)
projectConfig = system.file("extdata", "example_peps-master","example_subprojects1", "project_config.yaml", package="pepr")
p=Project(projectConfig)
```
An appropriate message is displayed, which informs you what are the names of the subprojects that you have defined in the `project_config.yaml` file. Nontheless, just the main project is "active".

Let's inspect it:

```{r}
samples(p)
```

The column `file_path` was derived and the `library` column holds the original attributes: `RRBS` for each sample.

To "activate" any of the subprojects just run the following line:

```{r}
pNewLib = activateSubproject(p,"newLib")
```

Let's inspect it:

```{r}
samples(pNewLib)
```

As you can see, the `library` columns consists of new attributes (`ABCD`), which were defined in the `sample_annotation_newLib.csv` file.

The second subproject can be activated in a similar way:

```{r}
pNewLib2 = activateSubproject(p, "newLib2")
samples(pNewLib2)
```

What is more, the `p` object consists of all the information from the project config file (`project_config.yaml`). Run the following line to explore it:

```{r}
config(p)
```



